package {{LowerCase .ControllerName}}


import (
	"{{.PackagePath}}/shared/config"
	"{{.PackagePath}}/shared/lazygo"
	"{{.PackagePath}}/shared/infrastructure/logger"
	"{{.PackagePath}}/shared/infrastructure/token"
	"{{.PackagePath}}/shared/model/stub"
	"syscall"
	"google.golang.org/grpc"
	"net"
)

//go:generate protoc -I . --go-grpc_out=../../../. --go_out=../../../. ./product.proto

type controller struct {
	ApplicationData lazygo.ApplicationData
	stub.UnimplementedServer
	lazygo.UsecaseRegisterer
	server   *grpc.Server
	log      logger.Logger
	cfg      *config.Config
	jwtToken token.JWTToken
}

func NewController(appData lazygo.ApplicationData, log logger.Logger, cfg *config.Config, jwtToken token.JWTToken) lazygo.ControllerRegisterer {

	server := grpc.NewServer()

	return &controller{
		ApplicationData: appData,
		UsecaseRegisterer: lazygo.NewBaseController(),
		server:            server,
		log:               log,
		cfg:               cfg,
		jwtToken:          jwtToken,
	}

}

func (r *controller) RegisterRouter() {
	stub.RegisterServer(r.server, r)
}

func (r *controller) Start() {
	addr := ":9000"
	listen, err := net.Listen("tcp", ":9000")
	if err != nil {
		panic(err)
	}

	sigChan := make(chan os.Signal, 1)
	signal.Notify(sigChan, os.Interrupt, syscall.SIGTERM)

	go func() {
		r.log.Info(context.Background(), "Server Running", r.log.Any("address", addr))
		if err := r.server.Serve(listen); err != nil {
			r.log.Error(context.Background(), "failed to serve:", err)
		}
	}()

	<-sigChan
	r.log.Info(context.Background(), "Shutting down gRPC server gracefully...")
	r.server.GracefulStop()
}

